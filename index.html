<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Renato Cavalcanti - Strong[Typed]">
<title>ActiveSlick</title>
<link rel="stylesheet" href="./foundation-blue.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./pygments-monokai.css">
</head>
<body class="article">
<div id="header">
<h1>ActiveSlick</h1>
<div class="details">
<span id="author" class="author">Renato Cavalcanti - Strong[Typed]</span><br>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>ActiveSlick is a library that offers CRUD operations for Slick 3.0 projects. The main goal is to provide some basic operations to manage the lifecycle of persisted objects (new/persisted/deleted/stale) and enable the implementation of the Active Record Pattern on Slick mapped case classes.</p>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_main_features">Main features</a></li>
<li><a href="#_project_artifact">Project artifact</a></li>
<li><a href="#_motivation">Motivation</a></li>
<li><a href="#_history">History</a></li>
<li><a href="#_entityactions">EntityActions</a>
<ul class="sectlevel2">
<li><a href="#_mapping_using_activeslick">Mapping using ActiveSlick</a></li>
<li><a href="#_building_blocks">Building blocks</a></li>
</ul>
</li>
<li><a href="#_transactions">Transactions</a></li>
<li><a href="#_optimistic_locking">Optimistic Locking</a></li>
<li><a href="#_before_insert_and_update_hooks">Before Insert and Update hooks</a></li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_main_features">Main features</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Basic CRUD and auxiliary methods - add/update/save, delete, findById, count and fetchAll (backed by Reactive Streams).</p>
</li>
<li>
<p>Generic Id type.</p>
</li>
<li>
<p>Optimistic locking my means of incremental version.</p>
</li>
<li>
<p>Before insert and update hooks.</p>
</li>
<li>
<p><strong>ActiveRecord</strong> trait to enable the Active Record Pattern on mapped case classes via class extensions (pimp-my-library style)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_project_artifact">Project artifact</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The artifacts are published to Sonatype Repository. Simply add the following to your build.sbt.</p>
</div>
<div class="paragraph">
<p>As of version 0.3.x we don&#8217;t support Slick 2.0 anymore. The differences between Slick 2.0 and Slick 3.0 are so huge that it makes impossible to support two versions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scala"><span class="tok-n">libraryDependencies</span> <span class="tok-o">+=</span> <span class="tok-s">&quot;io.strongtyped&quot;</span> <span class="tok-o">%%</span> <span class="tok-s">&quot;active-slick&quot;</span> <span class="tok-o">%</span> <span class="tok-s">&quot;0.3.1&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Source code for version 0.3.0 can be found at:
<a href="https://github.com/strongtyped/active-slick/tree/v0.3.1" class="bare">https://github.com/strongtyped/active-slick/tree/v0.3.1</a></p>
</div>
<div class="paragraph">
<p>The version supporting Slick 2.0 is still available on Sonatype Repo. However, this documentation only covers the current version (i.e.: 0.3.1).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scala"><span class="tok-n">libraryDependencies</span> <span class="tok-o">+=</span> <span class="tok-s">&quot;io.strongtyped&quot;</span> <span class="tok-o">%%</span> <span class="tok-s">&quot;active-slick&quot;</span> <span class="tok-o">%</span> <span class="tok-s">&quot;0.2.2&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Source code for version 0.2.2 can be found at:
<a href="https://github.com/strongtyped/active-slick/tree/v0.2.2" class="bare">https://github.com/strongtyped/active-slick/tree/v0.2.2</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Slick is able to map result sets to case classes or Tuples because of its isomorphism. This is done thanks to built-in Scala features. However, there is no direct link between case class fields and database columns. Everything is done based on isomorphic projections.</p>
</div>
<div class="paragraph">
<p>As a consequence, managing of Entities IDs must be done by hand, over and over again. One needs to save a model, ask Slick to return the generated ID and add it explicitly to the case class.</p>
</div>
<div class="paragraph">
<p>The following code fragment demonstrates how this is typically done in a Slick application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scala">  <span class="tok-k">import</span> <span class="tok-nn">slick.driver.H2Driver.api._</span>

  <span class="tok-k">case</span> <span class="tok-k">class</span> <span class="tok-nc">Coffee</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-k">:</span> <span class="tok-kt">String</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-k">:</span> <span class="tok-kt">Option</span><span class="tok-o">[</span><span class="tok-kt">Int</span><span class="tok-o">]</span> <span class="tok-k">=</span> <span class="tok-nc">None</span><span class="tok-o">)</span> <span class="tok-c1">// </span><i class="conum" data-value="1"></i><b>(1)</b>

  <span class="tok-k">class</span> <span class="tok-nc">CoffeeTable</span><span class="tok-o">(</span><span class="tok-n">tag</span><span class="tok-k">:</span> <span class="tok-kt">Tag</span><span class="tok-o">)</span> <span class="tok-k">extends</span> <span class="tok-nc">Table</span><span class="tok-o">[</span><span class="tok-kt">Coffee</span><span class="tok-o">](</span><span class="tok-n">tag</span><span class="tok-o">,</span> <span class="tok-s">&quot;COFFEE&quot;</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">def</span> <span class="tok-n">name</span> <span class="tok-k">=</span> <span class="tok-n">column</span><span class="tok-o">[</span><span class="tok-kt">String</span><span class="tok-o">](</span><span class="tok-s">&quot;NAME&quot;</span><span class="tok-o">)</span>
    <span class="tok-k">def</span> <span class="tok-n">id</span> <span class="tok-k">=</span> <span class="tok-n">column</span><span class="tok-o">[</span><span class="tok-kt">Int</span><span class="tok-o">](</span><span class="tok-s">&quot;ID&quot;</span><span class="tok-o">,</span> <span class="tok-n">O</span><span class="tok-o">.</span><span class="tok-nc">PrimaryKey</span><span class="tok-o">,</span> <span class="tok-n">O</span><span class="tok-o">.</span><span class="tok-nc">AutoInc</span><span class="tok-o">)</span> <span class="tok-c1">// </span><i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-k">def</span> <span class="tok-o">*</span> <span class="tok-k">=</span> <span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">.?)</span> <span class="tok-o">&lt;&gt;(</span><span class="tok-nc">Coffee</span><span class="tok-o">.</span><span class="tok-n">tupled</span><span class="tok-o">,</span> <span class="tok-nc">Coffee</span><span class="tok-o">.</span><span class="tok-n">unapply</span><span class="tok-o">)</span>
  <span class="tok-o">}</span>

  <span class="tok-k">val</span> <span class="tok-nc">Coffees</span> <span class="tok-k">=</span> <span class="tok-nc">TableQuery</span><span class="tok-o">[</span><span class="tok-kt">CoffeeTable</span><span class="tok-o">]</span>

  <span class="tok-k">val</span> <span class="tok-n">coffee</span> <span class="tok-k">=</span> <span class="tok-nc">Coffee</span><span class="tok-o">(</span><span class="tok-s">&quot;Colombia&quot;</span><span class="tok-o">)</span>
  <span class="tok-k">val</span> <span class="tok-n">insertAction</span> <span class="tok-k">=</span> <span class="tok-nc">Coffees</span><span class="tok-o">.</span><span class="tok-n">returning</span><span class="tok-o">(</span><span class="tok-nc">Coffees</span><span class="tok-o">.</span><span class="tok-n">map</span><span class="tok-o">(</span><span class="tok-k">_</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-o">))</span> <span class="tok-o">+=</span> <span class="tok-n">coffee</span> <span class="tok-c1">// </span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Both <strong>Coffee</strong> and <strong>CoffeeTable</strong> have an <strong>Id</strong> representing the primary key. <strong>Coffee</strong> has a field of type <strong>Option[Int]</strong></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>CoffeeTable</strong> has a method returning a <strong>Rep[Int]</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>However, in order to inserta new Coffee we need some boilerplate to get back the generated ID.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If we manage to connect both <strong>ID</strong> we can provide some generic functionality to manage Entities. Inserting a new <code>Entity</code> is only one of the possible use cases. With a well known ID, we can distinguish if an <code>Entity</code> has been already persisted or not, we can easilly implement byId methods (<code>deleteById</code>, <code>findById</code>) and we can add extensions methods like: <code>save</code>, <code>udpate</code>, <code>delete</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_history">History</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first intention of this project was to implement Slick DAOs or Repositories using only Scala features and the Scala compiler (no code generation).</p>
</div>
<div class="paragraph">
<p>In the time of Slick 2.0, this library required the usage of the Cake Pattern to wire together all the parts wihtout pre-defining a driver. Since Slick 3.0 imposes a huge refactoring, we decided to turn ActiveSlick inside out and eliminate the need of the Cake Pattern.</p>
</div>
<div class="paragraph">
<p>As a result, all special traits/classes like <code>TableId</code>, <code>TableWithIdQuery</code>, <code>EntityTableQuery</code>, etc, are gone. These classes could only compile if a driver was in scope. However, only the final user of the library can decide which driver to use. To overcome that situation we had to define everything inside components and wire them all together in a cake.</p>
</div>
<div class="paragraph">
<p>This approach was way to complex and hard to document. Users had to understand how to compose the traits and which classes to implement and/or mixin in order the get the desired effect.</p>
</div>
<div class="paragraph">
<p>From v.0.3.x onwards one can build a DAO/Repository and enable an ActiveRecord extension using plain old Slick mappings. Some configuration is needed, but it&#8217;s far more obvious to configure it than to compose and bake a cake.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_entityactions">EntityActions</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>EntityActions</code> is the main class we can use to build a DAO/Repository. It offers default implmentation for the following methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scala">  <span class="tok-cm">/** Returns total table count */</span>
  <span class="tok-k">def</span> <span class="tok-n">count</span><span class="tok-k">:</span> <span class="tok-kt">DBIO</span><span class="tok-o">[</span><span class="tok-kt">Int</span><span class="tok-o">]</span>

  <span class="tok-cm">/** Insert or Update a Model</span>
<span class="tok-cm">    * Insert `Model` if not yet persisted, otherwise update it.</span>
<span class="tok-cm">    * @return DBIO[Model] for a `Model` as persisted in the table.</span>
<span class="tok-cm">    */</span>
  <span class="tok-k">def</span> <span class="tok-n">save</span><span class="tok-o">(</span><span class="tok-n">entity</span><span class="tok-k">:</span> <span class="tok-kt">Model</span><span class="tok-o">)(</span><span class="tok-k">implicit</span> <span class="tok-n">exc</span><span class="tok-k">:</span> <span class="tok-kt">ExecutionContext</span><span class="tok-o">)</span><span class="tok-k">:</span> <span class="tok-kt">DBIO</span><span class="tok-o">[</span><span class="tok-kt">Model</span><span class="tok-o">]</span>

  <span class="tok-cm">/** Update a `Model`.</span>
<span class="tok-cm">    * @return DBIO[Model] for a `Model` as persisted in the table.</span>
<span class="tok-cm">    */</span>
  <span class="tok-k">def</span> <span class="tok-n">update</span><span class="tok-o">(</span><span class="tok-n">entity</span><span class="tok-k">:</span> <span class="tok-kt">Model</span><span class="tok-o">)(</span><span class="tok-k">implicit</span> <span class="tok-n">exc</span><span class="tok-k">:</span> <span class="tok-kt">ExecutionContext</span><span class="tok-o">)</span><span class="tok-k">:</span> <span class="tok-kt">DBIO</span><span class="tok-o">[</span><span class="tok-kt">Model</span><span class="tok-o">]</span>

  <span class="tok-cm">/** Delete a `Model`.</span>
<span class="tok-cm">    * @return DBIO[Int] with the number of affected rows</span>
<span class="tok-cm">    */</span>
  <span class="tok-k">def</span> <span class="tok-n">delete</span><span class="tok-o">(</span><span class="tok-n">entity</span><span class="tok-k">:</span> <span class="tok-kt">Model</span><span class="tok-o">)(</span><span class="tok-k">implicit</span> <span class="tok-n">exc</span><span class="tok-k">:</span> <span class="tok-kt">ExecutionContext</span><span class="tok-o">)</span><span class="tok-k">:</span> <span class="tok-kt">DBIO</span><span class="tok-o">[</span><span class="tok-kt">Int</span><span class="tok-o">]</span>

  <span class="tok-cm">/** Fetch all elements from a table.</span>
<span class="tok-cm">    * @param fetchSize - the number of row to fetch, defaults to 100</span>
<span class="tok-cm">    * @return StreamingDBIO[Seq[Model], Model]</span>
<span class="tok-cm">    */</span>
  <span class="tok-k">def</span> <span class="tok-n">fetchAll</span><span class="tok-o">(</span><span class="tok-n">fetchSize</span><span class="tok-k">:</span> <span class="tok-kt">Int</span> <span class="tok-o">=</span> <span class="tok-mi">100</span><span class="tok-o">)</span>
              <span class="tok-o">(</span><span class="tok-k">implicit</span> <span class="tok-n">exc</span><span class="tok-k">:</span> <span class="tok-kt">ExecutionContext</span><span class="tok-o">)</span><span class="tok-k">:</span> <span class="tok-kt">StreamingDBIO</span><span class="tok-o">[</span><span class="tok-kt">Seq</span><span class="tok-o">[</span><span class="tok-kt">Model</span><span class="tok-o">]</span>, <span class="tok-kt">Model</span><span class="tok-o">]</span>


  <span class="tok-cm">/** Insert a new `Entity`</span>
<span class="tok-cm">    * @return DBIO[Id] for the generated `Id`</span>
<span class="tok-cm">    */</span>
  <span class="tok-k">def</span> <span class="tok-n">insert</span><span class="tok-o">(</span><span class="tok-n">entity</span><span class="tok-k">:</span> <span class="tok-kt">Entity</span><span class="tok-o">)(</span><span class="tok-k">implicit</span> <span class="tok-n">exc</span><span class="tok-k">:</span> <span class="tok-kt">ExecutionContext</span><span class="tok-o">)</span><span class="tok-k">:</span> <span class="tok-kt">DBIO</span><span class="tok-o">[</span><span class="tok-kt">Id</span><span class="tok-o">]</span>

  <span class="tok-cm">/** Delete a `Entity` by `Id`</span>
<span class="tok-cm">    * @return DBIO[Int] with the number of affected rows</span>
<span class="tok-cm">    */</span>
  <span class="tok-k">def</span> <span class="tok-n">deleteById</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-k">:</span> <span class="tok-kt">Id</span><span class="tok-o">)(</span><span class="tok-k">implicit</span> <span class="tok-n">exc</span><span class="tok-k">:</span> <span class="tok-kt">ExecutionContext</span><span class="tok-o">)</span><span class="tok-k">:</span> <span class="tok-kt">DBIO</span><span class="tok-o">[</span><span class="tok-kt">Int</span><span class="tok-o">]</span>

  <span class="tok-cm">/** Finds `Entity` referenced by `Id`.</span>
<span class="tok-cm">    * May fail if no `Entity` is found for passed `Id`</span>
<span class="tok-cm">    * @return DBIO[Entity] for the `Entity`</span>
<span class="tok-cm">    */</span>
  <span class="tok-k">def</span> <span class="tok-n">findById</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-k">:</span> <span class="tok-kt">Id</span><span class="tok-o">)</span><span class="tok-k">:</span> <span class="tok-kt">DBIO</span><span class="tok-o">[</span><span class="tok-kt">Entity</span><span class="tok-o">]</span>

  <span class="tok-cm">/** Finds `Entity` referenced by `Id` optionally.</span>
<span class="tok-cm">    * @return DBIO[Option[Entity]] for the `Entity`</span>
<span class="tok-cm">    */</span>
  <span class="tok-k">def</span> <span class="tok-n">findOptionById</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-k">:</span> <span class="tok-kt">Id</span><span class="tok-o">)</span><span class="tok-k">:</span> <span class="tok-kt">DBIO</span><span class="tok-o">[</span><span class="tok-kt">Option</span><span class="tok-o">[</span><span class="tok-kt">Entity</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>EntityActions</code> implements to basic traits: <code>CrudActions</code> and <code>EntityActionsLike</code>. All method involving a <code>Model</code> are <code>Id</code> agnostic and are defined in <code>CrudActions</code>. Methods involving an <code>Entity</code> are defined by <code>EntityActionsLike</code>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_mapping_using_activeslick">Mapping using ActiveSlick</h3>
<div class="paragraph">
<p>The following code fragment illustrates how we can use ActiveSlick <code>EntityActions</code> to bind the <code>Entity</code> <code>Id</code> field and the <code>Table Id column</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scala"><span class="tok-k">import</span> <span class="tok-nn">io.strongtyped.active.slick._</span>
<span class="tok-k">import</span> <span class="tok-nn">slick.ast.BaseTypedType</span>
<span class="tok-k">import</span> <span class="tok-nn">slick.driver.H2Driver</span>
<span class="tok-k">import</span> <span class="tok-nn">io.strongtyped.active.slick.Lens._</span>
<span class="tok-k">import</span> <span class="tok-nn">scala.language.postfixOps</span>
<span class="tok-k">import</span> <span class="tok-nn">scala.concurrent.ExecutionContext.Implicits.global</span>

<span class="tok-k">object</span> <span class="tok-nc">MappingWithActiveSlick</span> <span class="tok-o">{</span>

  <span class="tok-k">case</span> <span class="tok-k">class</span> <span class="tok-nc">Coffee</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-k">:</span> <span class="tok-kt">String</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-k">:</span> <span class="tok-kt">Option</span><span class="tok-o">[</span><span class="tok-kt">Int</span><span class="tok-o">]</span> <span class="tok-k">=</span> <span class="tok-nc">None</span><span class="tok-o">)</span>

  <span class="tok-k">object</span> <span class="tok-nc">CoffeeRepo</span> <span class="tok-k">extends</span> <span class="tok-nc">EntityActions</span><span class="tok-o">(</span><span class="tok-n">H2Driver</span><span class="tok-o">)</span> <span class="tok-o">{</span>

    <span class="tok-k">import</span> <span class="tok-nn">jdbcProfile.api._</span> <span class="tok-c1">// </span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">val</span> <span class="tok-n">baseTypedType</span> <span class="tok-k">=</span> <span class="tok-n">implicitly</span><span class="tok-o">[</span><span class="tok-kt">BaseTypedType</span><span class="tok-o">[</span><span class="tok-kt">Id</span><span class="tok-o">]]</span> <span class="tok-c1">// </span><i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tok-k">type</span> <span class="tok-kt">Entity</span> <span class="tok-o">=</span> <span class="tok-nc">Coffee</span> <span class="tok-c1">// </span><i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-k">type</span> <span class="tok-kt">Id</span> <span class="tok-o">=</span> <span class="tok-nc">Int</span> <span class="tok-c1">// </span><i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-k">type</span> <span class="tok-kt">EntityTable</span> <span class="tok-o">=</span> <span class="tok-nc">CoffeeTable</span> <span class="tok-c1">// </span><i class="conum" data-value="5"></i><b>(5)</b>

    <span class="tok-k">val</span> <span class="tok-n">tableQuery</span> <span class="tok-k">=</span> <span class="tok-nc">TableQuery</span><span class="tok-o">[</span><span class="tok-kt">CoffeeTable</span><span class="tok-o">]</span> <span class="tok-c1">// </span><i class="conum" data-value="6"></i><b>(6)</b>

    <span class="tok-k">def</span> <span class="tok-nc">$id</span><span class="tok-o">(</span><span class="tok-n">table</span><span class="tok-k">:</span> <span class="tok-kt">CoffeeTable</span><span class="tok-o">)</span><span class="tok-k">:</span> <span class="tok-kt">Rep</span><span class="tok-o">[</span><span class="tok-kt">Id</span><span class="tok-o">]</span> <span class="tok-k">=</span> <span class="tok-n">table</span><span class="tok-o">.</span><span class="tok-n">id</span> <span class="tok-c1">// </span><i class="conum" data-value="7"></i><b>(7)</b>

    <span class="tok-k">val</span> <span class="tok-n">idLens</span> <span class="tok-k">=</span> <span class="tok-n">lens</span> <span class="tok-o">{</span> <span class="tok-n">coffee</span><span class="tok-k">:</span> <span class="tok-kt">Coffee</span> <span class="tok-o">=&gt;</span> <span class="tok-n">coffee</span><span class="tok-o">.</span><span class="tok-n">id</span>  <span class="tok-o">}</span> <span class="tok-c1">// </span><i class="conum" data-value="8"></i><b>(8)</b>
                      <span class="tok-o">{</span> <span class="tok-o">(</span><span class="tok-n">coffee</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-k">=&gt;</span> <span class="tok-n">coffee</span><span class="tok-o">.</span><span class="tok-n">copy</span><span class="tok-o">(</span><span class="tok-n">id</span> <span class="tok-k">=</span> <span class="tok-n">id</span><span class="tok-o">)</span> <span class="tok-o">}</span>

    <span class="tok-k">class</span> <span class="tok-nc">CoffeeTable</span><span class="tok-o">(</span><span class="tok-n">tag</span><span class="tok-k">:</span> <span class="tok-kt">Tag</span><span class="tok-o">)</span> <span class="tok-k">extends</span> <span class="tok-nc">Table</span><span class="tok-o">[</span><span class="tok-kt">Coffee</span><span class="tok-o">](</span><span class="tok-n">tag</span><span class="tok-o">,</span> <span class="tok-s">&quot;COFFEE&quot;</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-c1">// </span><i class="conum" data-value="9"></i><b>(9)</b>
      <span class="tok-k">def</span> <span class="tok-n">name</span> <span class="tok-k">=</span> <span class="tok-n">column</span><span class="tok-o">[</span><span class="tok-kt">String</span><span class="tok-o">](</span><span class="tok-s">&quot;NAME&quot;</span><span class="tok-o">)</span>
      <span class="tok-k">def</span> <span class="tok-n">id</span> <span class="tok-k">=</span> <span class="tok-n">column</span><span class="tok-o">[</span><span class="tok-kt">Id</span><span class="tok-o">](</span><span class="tok-s">&quot;ID&quot;</span><span class="tok-o">,</span> <span class="tok-n">O</span><span class="tok-o">.</span><span class="tok-nc">PrimaryKey</span><span class="tok-o">,</span> <span class="tok-n">O</span><span class="tok-o">.</span><span class="tok-nc">AutoInc</span><span class="tok-o">)</span>
      <span class="tok-k">def</span> <span class="tok-o">*</span> <span class="tok-k">=</span> <span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">.?)</span> <span class="tok-o">&lt;&gt;(</span><span class="tok-nc">Coffee</span><span class="tok-o">.</span><span class="tok-n">tupled</span><span class="tok-o">,</span> <span class="tok-nc">Coffee</span><span class="tok-o">.</span><span class="tok-n">unapply</span><span class="tok-o">)</span>
    <span class="tok-o">}</span>

    <span class="tok-k">def</span> <span class="tok-n">findByName</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-k">:</span><span class="tok-kt">String</span><span class="tok-o">)</span><span class="tok-k">:</span> <span class="tok-kt">DBIO</span><span class="tok-o">[</span><span class="tok-kt">Seq</span><span class="tok-o">[</span><span class="tok-kt">Coffee</span><span class="tok-o">]]</span> <span class="tok-k">=</span> <span class="tok-o">{</span>
      <span class="tok-n">tableQuery</span><span class="tok-o">.</span><span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-k">_</span><span class="tok-o">.</span><span class="tok-n">name</span> <span class="tok-o">===</span> <span class="tok-n">name</span><span class="tok-o">).</span><span class="tok-n">result</span>
    <span class="tok-o">}</span>
  <span class="tok-o">}</span>

  <span class="tok-k">implicit</span> <span class="tok-k">class</span> <span class="tok-nc">EntryExtensions</span><span class="tok-o">(</span><span class="tok-k">val</span> <span class="tok-n">entity</span><span class="tok-k">:</span> <span class="tok-kt">Coffee</span><span class="tok-o">)</span> <span class="tok-k">extends</span> <span class="tok-nc">ActiveRecord</span><span class="tok-o">[</span><span class="tok-kt">Coffee</span><span class="tok-o">]</span> <span class="tok-o">{</span>
    <span class="tok-k">val</span> <span class="tok-n">repository</span> <span class="tok-k">=</span> <span class="tok-nc">CoffeeRepo</span>
  <span class="tok-o">}</span>

  <span class="tok-k">val</span> <span class="tok-n">saveAction</span> <span class="tok-k">=</span> <span class="tok-nc">Coffee</span><span class="tok-o">(</span><span class="tok-s">&quot;Colombia&quot;</span><span class="tok-o">).</span><span class="tok-n">save</span><span class="tok-o">()</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The mapping is exactly the same. However, we define it inside <strong>CoffeeRepo</strong> which implements <strong>EntityActions</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_building_blocks">Building blocks</h3>
<div class="paragraph">
<p>The previous code fragment shows all necessary building blocks we need:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The first thing to note is the <code>import jdbcProfile.api._</code>. As said before Slick requires jdbc driver. If this line is not included many of the necessary Slick traits, classes and extension methods won&#8217;t be available.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define a <code>BaseTypedType</code> for the <code>Entity&#8217;s Id by looking up on the implicit scope. This is probably the most  intriging one. This is necessary to build queries involving the `Id</code>. Note that you don&#8217;t need to make it implicit yourself. This is already done by the internals of <code>EntityActions</code> implementation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Type Alias for the <code>Entity</code> type.  We choose to use <strong>Type Aliases</strong> instead of <strong>Type Parameters</strong> because it make the code a little bit cleaner when composing with other traits. (see <code>OptimisticLocking</code> trait and <code>SupplierDao</code> in <code>Schema.scala</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Type Alias for the Entity&#8217;s <code>Id</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Type Alias pointing to the Entity&#8217;s Table. This is required by <code>EntityActions</code> as the predefined methods must know the type of the table.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The ubiquitous Slick <code>TableQuery</code>. This is required by <code>EntityActions</code> in order to implement the basic methods.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>A method returning the <code>Id</code> column (ie: <code>Rep[Id]</code>). This is how we indicate which table column must be used for all operations involving the primary key.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Finally a <code>Lens</code> to get and set the <code>Id</code> on the <code>Entity</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We have now a well known column for our primary key. The next step is to define the method to extract the id from our model and to add a generated id back into the model.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_transactions">Transactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As of version 0.3.0 and the introduction of <code>DBIO</code> in Slick 3.0, all methods return <code>DBIO</code> (not <code>Futures</code>). In Slick 3.0 the DB sessions and the transactional sessions are not passed as implicit parameters therefore is the user that have to manage the sessions and transactions.</p>
</div>
<div class="paragraph">
<p>If ActiveSlick were returning Futures instead, then the transactions will have to be managed internally by <strong>ActiveSlick</strong> which is of course not desirable.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_optimistic_locking">Optimistic Locking</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Optimistic locking is supported by means for a version column of type <code>Long</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scala">  <span class="tok-k">case</span> <span class="tok-k">class</span> <span class="tok-nc">Coffee</span><span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-k">:</span> <span class="tok-kt">String</span><span class="tok-o">,</span> <span class="tok-n">version</span><span class="tok-k">:</span> <span class="tok-kt">Long</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-k">:</span> <span class="tok-kt">Option</span><span class="tok-o">[</span><span class="tok-kt">Int</span><span class="tok-o">]</span> <span class="tok-k">=</span> <span class="tok-nc">None</span><span class="tok-o">)</span>

  <span class="tok-k">object</span> <span class="tok-nc">CoffeeRepo</span> <span class="tok-k">extends</span> <span class="tok-nc">EntityActions</span><span class="tok-o">(</span><span class="tok-n">H2Driver</span><span class="tok-o">)</span> <span class="tok-k">with</span> <span class="tok-nc">OptimisticLocking</span> <span class="tok-o">{</span>

    <span class="tok-k">import</span> <span class="tok-nn">jdbcProfile.api._</span>

    <span class="tok-k">def</span> <span class="tok-nc">$version</span><span class="tok-o">(</span><span class="tok-n">table</span><span class="tok-k">:</span> <span class="tok-kt">CoffeeTable</span><span class="tok-o">)</span><span class="tok-k">:</span> <span class="tok-kt">Rep</span><span class="tok-o">[</span><span class="tok-kt">Long</span><span class="tok-o">]</span> <span class="tok-k">=</span> <span class="tok-n">table</span><span class="tok-o">.</span><span class="tok-n">version</span> <span class="tok-c1">// </span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">def</span> <span class="tok-n">versionLens</span> <span class="tok-k">=</span> <span class="tok-n">lens</span> <span class="tok-o">{</span> <span class="tok-n">coffee</span><span class="tok-k">:</span><span class="tok-kt">Coffee</span> <span class="tok-o">=&gt;</span> <span class="tok-n">coffee</span><span class="tok-o">.</span><span class="tok-n">version</span> <span class="tok-o">}</span>  <span class="tok-c1">// </span><i class="conum" data-value="2"></i><b>(2)</b>
                           <span class="tok-o">{</span> <span class="tok-o">(</span><span class="tok-n">coffee</span><span class="tok-o">,</span> <span class="tok-n">vers</span><span class="tok-o">)</span> <span class="tok-k">=&gt;</span> <span class="tok-n">coffee</span><span class="tok-o">.</span><span class="tok-n">copy</span><span class="tok-o">(</span><span class="tok-n">version</span> <span class="tok-k">=</span> <span class="tok-n">vers</span><span class="tok-o">)</span> <span class="tok-o">}</span>


    <span class="tok-k">class</span> <span class="tok-nc">CoffeeTable</span><span class="tok-o">(</span><span class="tok-n">tag</span><span class="tok-k">:</span> <span class="tok-kt">Tag</span><span class="tok-o">)</span> <span class="tok-k">extends</span> <span class="tok-nc">Table</span><span class="tok-o">[</span><span class="tok-kt">Coffee</span><span class="tok-o">](</span><span class="tok-n">tag</span><span class="tok-o">,</span> <span class="tok-s">&quot;COFFEE&quot;</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-k">def</span> <span class="tok-n">name</span> <span class="tok-k">=</span> <span class="tok-n">column</span><span class="tok-o">[</span><span class="tok-kt">String</span><span class="tok-o">](</span><span class="tok-s">&quot;NAME&quot;</span><span class="tok-o">)</span>
      <span class="tok-k">def</span> <span class="tok-n">id</span> <span class="tok-k">=</span> <span class="tok-n">column</span><span class="tok-o">[</span><span class="tok-kt">Id</span><span class="tok-o">](</span><span class="tok-s">&quot;ID&quot;</span><span class="tok-o">,</span> <span class="tok-n">O</span><span class="tok-o">.</span><span class="tok-nc">PrimaryKey</span><span class="tok-o">,</span> <span class="tok-n">O</span><span class="tok-o">.</span><span class="tok-nc">AutoInc</span><span class="tok-o">)</span>
      <span class="tok-k">def</span> <span class="tok-n">version</span> <span class="tok-k">=</span> <span class="tok-n">column</span><span class="tok-o">[</span><span class="tok-kt">Long</span><span class="tok-o">](</span><span class="tok-s">&quot;VERSION&quot;</span><span class="tok-o">)</span>
      <span class="tok-k">def</span> <span class="tok-o">*</span> <span class="tok-k">=</span> <span class="tok-o">(</span><span class="tok-n">name</span><span class="tok-o">,</span> <span class="tok-n">version</span><span class="tok-o">,</span> <span class="tok-n">id</span><span class="tok-o">.?)</span> <span class="tok-o">&lt;&gt;(</span><span class="tok-nc">Coffee</span><span class="tok-o">.</span><span class="tok-n">tupled</span><span class="tok-o">,</span> <span class="tok-nc">Coffee</span><span class="tok-o">.</span><span class="tok-n">unapply</span><span class="tok-o">)</span>
    <span class="tok-o">}</span>
    <span class="tok-o">...</span>
  <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>OptimisticLocking</code> requires two new methods to implement in order to glue the <code>version</code> field to the <code>version</code> column.</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A method returning the <code>version</code> column (ie: <code>Rep[Long]</code>). This is how we indicate which table column must be used store the version information.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A <code>Lens</code> to get and set the <code>version</code> on the <code>Entity</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Note that we can mixin the trait <code>OptimisticLocking</code> without specifying the type of the <code>Entity</code> nor the <code>Id</code> type. This is due to the usage of Type Alias.</p>
</div>
<div class="paragraph">
<p>If we were using Type Parameters, we&#8217;ll be forced to repeat the types each time as in:
<code>EntityActions[Coffee, Int](H2Driver) with OptimisticLocking[Coffee, Int]</code></p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_insert_and_update_hooks">Before Insert and Update hooks</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>EntityActions</code> provide two hooks to modify Entity data before insert and update. One can overwrite these methods to add extra checks or modify the <code>Entity</code> just before insert and updates.</p>
</div>
<div class="paragraph">
<p>A possible usage could be to automatically update <code>lastUpdated</code> field for audit purposes.
(see <code>EntityActionsBeforeInsertUpdateTest.scala</code> for a concrete example)</p>
</div>
<div class="paragraph">
<p>In both cases, the returned DBIO is combined will be combined with the corresponding DBIO (from insert or update methods) and executed in the same transaction.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scala"><span class="tok-k">def</span> <span class="tok-n">beforeInsert</span><span class="tok-o">(</span><span class="tok-n">entity</span><span class="tok-k">:</span> <span class="tok-kt">Entity</span><span class="tok-o">)(</span><span class="tok-k">implicit</span> <span class="tok-n">exc</span><span class="tok-k">:</span> <span class="tok-kt">ExecutionContext</span><span class="tok-o">)</span><span class="tok-k">:</span> <span class="tok-kt">DBIO</span><span class="tok-o">[</span><span class="tok-kt">Entity</span><span class="tok-o">]</span> <span class="tok-k">=</span> <span class="tok-o">{</span>
    <span class="tok-c1">// default implementation does nothing</span>
    <span class="tok-nc">DBIO</span><span class="tok-o">.</span><span class="tok-n">successful</span><span class="tok-o">(</span><span class="tok-n">entity</span><span class="tok-o">)</span>
<span class="tok-o">}</span>

<span class="tok-k">def</span> <span class="tok-n">beforeUpdate</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-k">:</span> <span class="tok-kt">Id</span><span class="tok-o">,</span> <span class="tok-n">entity</span><span class="tok-k">:</span> <span class="tok-kt">Entity</span><span class="tok-o">)(</span><span class="tok-k">implicit</span> <span class="tok-n">exc</span><span class="tok-k">:</span> <span class="tok-kt">ExecutionContext</span><span class="tok-o">)</span><span class="tok-k">:</span> <span class="tok-kt">DBIO</span><span class="tok-o">[</span><span class="tok-kt">Entity</span><span class="tok-o">]</span> <span class="tok-k">=</span> <span class="tok-o">{</span>
    <span class="tok-c1">// default implementation does nothing</span>
    <span class="tok-nc">DBIO</span><span class="tok-o">.</span><span class="tok-n">successful</span><span class="tok-o">(</span><span class="tok-n">entity</span><span class="tok-o">)</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_main_features">Main features</a></li>
<li><a href="#_project_artifact">Project artifact</a></li>
<li><a href="#_motivation">Motivation</a></li>
<li><a href="#_history">History</a></li>
<li><a href="#_entityactions">EntityActions</a>
<ul class="sectlevel2">
<li><a href="#_mapping_using_activeslick">Mapping using ActiveSlick</a></li>
<li><a href="#_building_blocks">Building blocks</a></li>
</ul>
</li>
<li><a href="#_transactions">Transactions</a></li>
<li><a href="#_optimistic_locking">Optimistic Locking</a></li>
<li><a href="#_before_insert_and_update_hooks">Before Insert and Update hooks</a></li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-08-15 02:43:21 CEST
</div>
</div>
</body>
</html>